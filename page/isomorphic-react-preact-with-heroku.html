<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="description" content="A minimalist programmer, photographer and lifes lover."/>
    <title>Isomorphic React/Preact with Heroku | David Zhang</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="https://crispgm.com/page/isomorphic-react-preact-with-heroku.html">
    <link rel="alternate" href="https://crisp.lol/page/isomorphic-react-preact-with-heroku.html">
    <link rel="alternate" href="https://crispgm.com/feed.xml" type="application/rss+xml" title="RSS">
    <link href="//fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Crimson+Text:400,400italic&amp;subset=latin,latin-ext" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/image/logo.png">
    
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/animatecss/3.5.2/animate.min.css">
    
    <link rel="stylesheet" href="/assets/css/tomorrow-night-eighties.css">
    
    
    <link rel="stylesheet" href="/assets/css/style.css">
  </head>
  <body>
    <div class="content" id="header">
          <header class="content-wrapper menu">
      <div class="menu-links">
        <div class="menu-item">
          <a href="/blog.html">Blog</a>
        </div>
        <div class="menu-item">
          <a href="/project.html">Project</a>
        </div>
        <div class="menu-item">
          <a href="/wiki/">Wiki</a>
        </div>
        <div class="menu-item">
          <a href="/things.html">Things</a>
        </div>
        <div class="menu-item">
          <a href="/bio.html">Bio</a>
        </div>
        <div class="menu-item">
          <a href="/about.html">About</a>
        </div>
      </div>
      <div class="menu-bars">
        <i id="dropdown-button" class="fa fa-bars"></i>
      </div>
      <div class="menu-home">
        <a href="/">DAVID ZHANG</a>
      </div>
    </header>

    </div>
    <div class="content" id="main-content">
      <div class="content-wrapper">
        <div class="article">
  <div class="article-head">
    <div class="article-title">Isomorphic React/Preact with Heroku</div>
    <div class="article-date">July 06, 2017</div>
  </div>
  <div class="article-main">
    <p><a href="http://rugbynews.space">Rugby News Board</a> is the side project mentioned in title, which is a simple news site for Rugby sport in Chinese. I made it because there is not Rugby news site in Chinese and I love Rugby.</p>

<p>Rugby News Board was <a href="https://github.com/crispgm/rugby-board">firstly built</a> with Rails, with simple news channels. By Rails, I could be able to make prototype within 2 days. I wrote a <code class="highlighter-rouge">news</code> table with ORM with SQLite. It ran on Linode VPS and I did DevOps by myself.</p>

<h1 id="heroku">Heroku</h1>

<p>Since I read about the article from Unsplash <a href="https://medium.com/unsplash-unfiltered/scaling-unsplash-with-a-small-team-fbdd55571906"><em>Scaling Unsplash with a small team</em></a>, I realized that I should emigrate from VPS to PaaS to avoid unnecessary cost for infrastructures. I have kept on <a href="/page/containerize-my-vps.html">evaluating containers and other technology</a> on the VPS but it was neither profitable nor productive to the project.</p>

<p>As a result, I started to migrate to <a href="https://heroku.com/">Heroku</a>, as I sought for more efficiency, reliability and convenience. The process didn’t take too much effort. The only major change to my Rails app is that the database was <a href="https://devcenter.heroku.com/articles/sqlite3">changed into Postgres</a>.</p>

<h1 id="isomorphic-javascript">Isomorphic JavaScript</h1>

<p>Rails is flexible both backend and frontend, with components support for everything, and it is a perfect MVC framework for multiple pages application. However, MVVM
is the future, e.g. React. It is a bit more reasonable, elegant and expressive way to make data reactive than modify DOM with jQuery. <strong>Moreover, I just want to keep on track with modern frontend development</strong>.</p>

<p>By the way, I feel quite strange using CoffeeScript, as part of Rails stacks. Being surrounded by Vanilla JavaScript, EcmaScript of all versions, and TypeScript, I have no interest in learning an unpopular JavaScript replacement, which some dudes said it was dead.</p>

<p>I tried using React with <a href="https://github.com/reactjs/react-rails">react-rails</a> to build translator system of Rugby names. It is merely based on Rails, and we can use React Component with <code class="highlighter-rouge">react_component</code> tag and simply pass the data to the component:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"section-item"</span><span class="nt">&gt;</span>
  <span class="err">&lt;</span>%= react_component "RugbyDictQuery", {title: "Rugby Dictionary"} %&gt;
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p>react-rails is a great binding between Rails and React. But the trend is isomorphic React application as frontend and backends serve only APIs. I read some articles and slides from companies use both Rails and React, such as <a href="https://www.slideshare.net/spikebrehm/the-evolution-of-airbnbs-frontend/"><em>The Evolution of Airbnb’s Frontend</em></a> and <a href="https://medium.com/unsplash-unfiltered/scaling-unsplash-with-a-small-team-fbdd55571906"><em>Scaling Unsplash with a small team</em></a> again.</p>

<p>They both prefered build isomorphic JavaScript application with Node and React. I followed Unsplash, because we use the same PaaS and frameworks.</p>

<h2 id="react-app">React App</h2>

<p>Initially, I setup my project with <a href="https://github.com/verekia/js-stack-from-scratch"><em>JavaScript Stack from Scratch</em></a>. I won’t post many <a href="https://github.com/rugby-board/rugby-board-node">codes</a> here, since it is routine work with React.</p>

<h2 id="build-after-deployment">Build after Deployment</h2>

<p>Deployment on Heroku is easy, but I had to commit <code class="highlighter-rouge">dist</code> folder to codebase at first, which was not an elegant way. Then I found <code class="highlighter-rouge">heroku-postbuild</code> hook, by which deployment can trigger Webpack build.</p>

<p>Add <code class="highlighter-rouge">heroku-postbuild</code> to <code class="highlighter-rouge">package.json</code>：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>"heroku-postbuild": "webpack -p --config ./config/webpack.prod.config.js"
</code></pre>
</div>

<h1 id="optimizing-and-preact">Optimizing and Preact</h1>

<p>After the launch of new Node/React application, I could hardly ignore the long gap before I saw the page finally. Heroku is commonly lag in China due to firewall. I put it down to this reason until I found the <code class="highlighter-rouge">bundle.js</code> is 1.8 mb.</p>

<p>The reason is Webpack production configuration is wrong, I fixed it by adding <code class="highlighter-rouge">UglifyJsPlugin</code> and it is now 700 kb.</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="nx">plugins</span><span class="err">:</span> <span class="p">[</span>
  <span class="nx">HtmlWebpackPluginConfig</span><span class="p">,</span>
  <span class="k">new</span> <span class="nx">webpack</span><span class="p">.</span><span class="nx">NoEmitOnErrorsPlugin</span><span class="p">(),</span>
  <span class="k">new</span> <span class="nx">webpack</span><span class="p">.</span><span class="nx">DefinePlugin</span><span class="p">({</span> <span class="s1">'process.env.NODE_ENV'</span><span class="p">:</span> <span class="s1">'"production"'</span> <span class="p">}),</span>
  <span class="k">new</span> <span class="nx">webpack</span><span class="p">.</span><span class="nx">optimize</span><span class="p">.</span><span class="nx">OccurrenceOrderPlugin</span><span class="p">(),</span>
  <span class="k">new</span> <span class="nx">webpack</span><span class="p">.</span><span class="nx">optimize</span><span class="p">.</span><span class="nx">UglifyJsPlugin</span><span class="p">({</span>
    <span class="na">compress</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">screw_ie8</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">warnings</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="na">mangle</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">screw_ie8</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="na">output</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">comments</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">screw_ie8</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">}),</span>
<span class="p">],</span>
</code></pre>
</div>

<p>Even 700 kb is not good. And then I came up with an idea of using <a href="https://github.com/developit/preact">Preact</a>, “Fast 3kb React alternative with the same ES6 API”, which is confirmed by my frontend expert friend <a href="https://github.com/yanni4night">@yanni4night</a>.</p>

<p>I had no many codes so I use Preact directly, without using preact-compat to make it compatible with React.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>import { h, Component } from 'preact';
</code></pre>
</div>

<p>It goes as soon as I change the import statements on the top.</p>

<p>react-router was replaced by preact-router, which is even user-friendly. The parameters are simply passed to <code class="highlighter-rouge">props</code>:</p>

<p>Router:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;EventPage path="/event/:name" /&gt;
</code></pre>
</div>

<p>EventPage Component:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>export default class EventPage extends Component {
  constructor(props) {
    super(props);

    this.state = {
      eventName: props.name,
      pageNum: props.page || 0,
    };
  }
}
</code></pre>
</div>

<p>After the optimization, it is <em>only</em> 364 kb and typically takes less than 2 seconds to load the application. Using Preact is a good choice, while we can get the advantage of React and benefit from the lightweight.</p>

<h1 id="conclusion">Conclusion</h1>

<p>The development experience of frontend is great, with fancy frameworks, tools and developer’s ecology. It evolves very fast, faster than evolvement of its documentation. The examples of the documentations fail frequently as version increases fast. But, it’s fantastic that they often give accurate migration advice so that I can fix immediately. For other problems, StackOverflow provides strong supports as frontend people are the most vigorous in the industry.</p>

  </div>
  
  <hr>
  <div class="article-tag">
    
    <div class="tag-item">
    Preact
    </div>
    
    <div class="tag-item">
    React
    </div>
    
    <div class="tag-item">
    Rails
    </div>
    
    <div class="tag-item">
    Heroku
    </div>
    
  </div>
  
  <div id="disqus_thread"></div>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

      </div>
    </div>
        <footer>
      <div class="content-wrapper" id="contact">
        <div id="links">
          <a href="mailto:crispgm@gmail.com"><i class="fa fa-envelope-o"></i></a>
          <a href="/feed.xml"><i class="fa fa-rss"></i></a>
          <a href="https://github.com/crispgm"><i class="fa fa-github"></i></a>
          <a href="https://stackoverflow.com/users/6858150/david-zhang/"><i class="fa fa-stack-overflow"></i></a>
          <a href="https://instagram.com/crispgm"><i class="fa fa-instagram"></i></a>
          <a href="https://twitter.com/crispgm"><i class="fa fa-twitter"></i></a>
          <a href="http://medium.com/@crispgm"><i class="fa fa-medium"></i></a>
          <a href="https://www.linkedin.com/in/wanlong-zhang"><i class="fa fa-linkedin"></i></a>
        </div>

        <div id="copyright">
          David Zhang &copy; 2017
        </div>
      </div>
    </footer>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        isToggle = false;

        document.body.addEventListener("click", function(evt){
          if (isToggle && evt.target.id != 'dropdown-button') {
            toggleMenu();
          }
        });

        var dropdown = document.querySelector("#dropdown-button");
        dropdown.addEventListener("click", function(evt) {
          toggleMenu();
        });

        document.body.addEventListener("touchstart", function(evt){
          evt.stopPropagation();
        });
      }, false);

      function toggleMenu() {
        var menuElement = document.querySelector(".menu-links");
        var dropdownElement = document.querySelector("#dropdown-button");
        if (isToggle) {
          menuElement.classList.remove("menu-dropdown");
          menuElement.classList.remove("animated");
          menuElement.classList.remove("fadeIn");
          dropdownElement.classList.remove("fa-close");
          dropdownElement.classList.remove("fa-inverse");
          dropdownElement.classList.add("fa-bars");
        }
        else {
          menuElement.classList.add("menu-dropdown");
          menuElement.classList.add("animated");
          menuElement.classList.add("fadeIn");
          dropdownElement.classList.remove("fa-bars");
          dropdownElement.classList.add("fa-close");
          dropdownElement.classList.add("fa-inverse");
        }
        isToggle = !isToggle;
      }
    </script>
    
    <script src="/assets/scripts/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-50708664-1', 'auto');
      ga('send', 'pageview');
    </script>
    
    <script>
    var disqus_config = function () {
      this.page.identifier = '/page/isomorphic-react-preact-with-heroku.html';
    };
    
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://crispgm.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    
  </body>
</html>