<!DOCTYPE html>
<html>
  <head>
  <meta charset="UTF-8">
  <meta name="description" content="Home page and blog of David Zhang (@crispgm), a minimalist programmer, photographer, and lifehacker."/>
  <title>Containerizing My VPS | David Zhang</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="canonical" href="https://crispgm.com/page/containerizing-my-vps.html">
  
  <link rel="alternate" href="https://crisp.dev/page/containerizing-my-vps.html">
  
  <link rel="alternate" href="https://crispgm.com/feed.xml" type="application/rss+xml" title="RSS">
  <link href="https://fonts.googleapis.com/css?family=Fira+Sans|Fira+Mono" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/image/logo.png">
  
  <link rel="stylesheet" href="/assets/css/font.css?v=1576639270">
  
  
  <link rel="stylesheet" href="/assets/css/nord.css">
  
  <link rel="stylesheet" href="/assets/css/style.css">
  <script src="https://use.typekit.net/syr2mmc.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>
</head>

  <body>
    <div class="progress-bar"></div>
    <div class="wrapper blog-wrapper content-wrapper">
      <div class="article">
        <div class="article-menu">
          <div class="article-home">
            <a href="/">DAVID ZHANG</a>
          </div>
          <div class="article-back">
            <a href="/blog.html"><< Back</a>
          </div>
        </div>
        <div class="article-head">
          <div class="article-title">
            Containerizing My VPS
          </div>
          <div class="article-date">
            <time datetime="2016-09-18 00:00:00 +0800">September 18, 2016</time>
          </div>
        </div>
        <div class="article-main">
          <p>Docker is the <em>hyped</em> technology in backend recently. I have no chance to use Docker, since the company I serve has been on private PaaS years before. Fortunately, I encountered problems with my own VPS. Thus, I decided to try Docker and now I want to share the process and my thought.</p>

<h1 id="problems">Problems</h1>

<p>So far, I use Linode VPS to deploy my websites. I update and deploy my personal website frequently, and I use GitHub webhook to trigger the updating script. With the deterioration of China’s web environment, I have to build VPN and Shadowsocks for myself, which is useful for productivity.</p>

<p>At present, there are several services running on the VPS:</p>

<ul>
  <li>Personal website (generated by Jekyll, HTTPS certificated by Certbot<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>, served by Nginx)</li>
  <li>Personal website updater</li>
  <li>Shadowsocks server (the core function, VPN is kind of a substitute)</li>
  <li>PPTP VPN (changed to L2TP, since PPTP support is removed in iOS 10<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>)</li>
  <li>Side projects</li>
</ul>

<p>It seems not complicated but I did encounter problems on ops and security.</p>

<h2 id="provisioning">Provisioning</h2>

<p>VPS provisioning is not automated and manual provisioning is trivial and boring.</p>

<p>On July, it was attacked and I had to rebuild my Linode. I then changed the default SSH port and it took tens of minutes to rebuild manually. Especially setting up VPN server is not easy and fallible.</p>

<h2 id="security-risks">Security Risks</h2>

<p>In addition to aforementioned attacks, there are other kind of security risks. For example, Shell injection and actually I just fixed one on the projects.</p>

<h2 id="disturbance-among-services">Disturbance Among Services</h2>

<p>Different programs may have conflicts with each other. For example, iptables is needed by VPN and it may cause failure of Nginx’s port with wrong configuration.</p>

<p>Also, it’s not only a production server but also used in development mode, which generates trashes in system folders.</p>

<p>Therefore, my requirements are:</p>

<ul>
  <li>Simple and fast provisioning. Instant and recoverable.</li>
  <li>Programs run in restricted sandboxes with isolated resources.</li>
</ul>

<h1 id="why-docker">Why Docker</h1>

<p>Docker is a major containerization software, which packs applications into image and runs in container. The definition of container is:</p>

<blockquote>
  <p>Using containers, everything required to make a piece of software run is packaged into isolated containers. Unlike VMs, containers do not bundle a full operating system - only libraries and settings required to make the software work are needed. This makes for efficient, lightweight, self-contained systems and guarantees that software will always run the same, regardless of where it’s deployed.<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup></p>
</blockquote>

<p>Docker just meets my requirement, because of its container system. I can run the independent parts in different containers and rebuild a new Linode by initiating all the containers in an efficient way. Even I can scale my applications by the power of Docker.</p>

<p>Every cutting-edge popular (somehow over-hyped) technology solves problems. And Docker is a trend in infrastructure field.</p>

<p>I want to continue to use and build Docker on my current VPS node, as it has a good latency between Tokyo and Beijing, with a low ping of about 80ms. Luckily, Linode has started to support Docker since 2014<sup id="fnref:4"><a href="#fn:4" class="footnote">4</a></sup>.</p>

<h2 id="install-docker">Install Docker</h2>

<p>My Linux image is Ubuntu 14.04 LTS, installation is quite easy<sup id="fnref:5"><a href="#fn:5" class="footnote">5</a></sup>, simply execute:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -sSL https://get.docker.com/ | sh
</code></pre></div></div>

<p>P.S.: I used Ubuntu 16.04 LTS image at first, which is the lastest. But it’s not recommended. This version has conflict with <code class="highlighter-rouge">systemd</code>. In consequence, I got stuck in starting <code class="highlighter-rouge">docker-engine</code>, though I found the <a href="http://stackoverflow.com/questions/37227349/unable-to-start-docker-service-in-ubuntu-16-04/37640824#37640824" target="_blank">solution on StackOverflow</a>.</p>

<h2 id="make-images">Make Images</h2>

<p>Based on “products”, I need to build four container:</p>

<ul>
  <li>Nginx</li>
  <li>Certbot</li>
  <li>Website updater</li>
  <li>Shadowsocks</li>
  <li>L2TP VPN Server</li>
</ul>

<p>An image is describe as <code class="highlighter-rouge">Dockerfile</code>, which is a Shell-like description file. Actually, there are images for me on Docker Hub, which is the Docker GitHub equivalent. This shows one of the advantages of Docker that, we may distribute softwares with Docker.</p>

<p>I found a <a href="https://github.com/hwdsl2/docker-ipsec-vpn-server">hwdsl2/docker-ipsec-vpn-server</a>, which is so complicated that use an exsited image saves me lots of time.</p>

<p>For simplicity, I built Shadowsocks image by myself.</p>

<p>It is not hard for a Shell user to quick start on Dockerfile, which consists of some declarations and installation processes. I simply got started by reading the <a href="https://docs.docker.com/engine/reference/builder/">reference</a>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM ubuntu:trusty
MAINTAINER David Zhang &lt;crispgm@gmail.com&gt;
RUN apt-get update \
    &amp;&amp; apt-get install -y python-pip \
    &amp;&amp; pip install shadowsocks

COPY etc/shadowsocks.json /etc/shadowsocks.json

EXPOSE 2968

CMD /usr/local/bin/ssserver -c /etc/shadowsocks.json -d start
</code></pre></div></div>

<p>The image is based on <code class="highlighter-rouge">ubuntu:trusty</code>, of which the version can have no relationship with the host OS. Shadowsocks is distributed on pip. Therefore, executing <code class="highlighter-rouge">pip install</code> is the only thing in installation. At last, don’t forget to <code class="highlighter-rouge">COPY</code> configuration file into the image and <code class="highlighter-rouge">EXPOSE</code> inner port to host OS. The <code class="highlighter-rouge">CMD</code> command is the starting point.</p>

<h2 id="start-container">Start Container</h2>

<p>Build the Dockerfile:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build -t crisp/shadowsocks .
</code></pre></div></div>

<p>Start in daemon mode:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --name ssserver -d -p 2968:2968 crisp/shadowsocks
</code></pre></div></div>

<p>Then I ran <code class="highlighter-rouge">docker ps</code> but found that the container had been shutdown, no containers listed.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
</code></pre></div></div>

<p>Docker runs only if there is a foreground process, instead of a daemon process. Shadowsocks offers foreground mode but typical server’s programs run in daemon. Here is a trick:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CMD /usr/local/bin/ssserver -c /etc/shadowsocks.json -d start \
    &amp;&amp; tail -f /var/log/shadowsocks.log
</code></pre></div></div>

<p>As a result, the container runs <code class="highlighter-rouge">tail</code> command on foreground.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker ps
CONTAINER ID IMAGE             COMMAND                CREATED      STATUS      PORTS                  NAMES
81f57c6c0710 crisp/shadowsocks "/bin/sh -c '/usr/loc" 22 hours ago Up 22 hours 0.0.0.0:2967-&gt;2968/tcp ssserver
</code></pre></div></div>

<p>So far, the <em>containerization</em> progress bar reached 100%. Here is the <a href="https://github.com/crispgm/docker">Dockerfiles</a>.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Compared to VMs that in lower level, Docker focuses on virtualization of applications and provides deployable softwares. We can quickly build and ship applications.</p>

<p>In addition, Docker plays an important role in CI/CD fields and I will dive into it in the future.</p>

<hr />

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>Enable HTTPS with Let’s Encrypt. <a href="https://crispgm.com/page/enable-https-with-letsencrypt.html">https://crispgm.com/page/enable-https-with-letsencrypt.html</a>. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>Prepare for removal of PPTP VPN before you upgrade to iOS 10 and macOS Sierra. <a href="https://support.apple.com/en-us/HT206844">https://support.apple.com/en-us/HT206844</a>. <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>Docker on Linode. <a href="https://blog.linode.com/2014/01/03/docker-on-linode/">https://blog.linode.com/2014/01/03/docker-on-linode/</a>. <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p>What is Docker <a href="https://www.docker.com/what-docker">https://www.docker.com/what-docker</a>. <a href="#fnref:4" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:5">
      <p>Docker Quick Reference. <a href="https://www.linode.com/docs/applications/containers/docker-quick-reference-cheat-sheet">https://www.linode.com/docs/applications/containers/docker-quick-reference-cheat-sheet</a>. <a href="#fnref:5" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

        </div>
        <div class="article-share">
          <a href="https://twitter.com/share?url=https%3A%2F%2Fcrispgm.com%2Fpage%2Fcontainerizing-my-vps.html&text=Containerizing+My+VPS">
            <i class="icon-twitter"></i>
          </a>
          
          <a href="tg://msg_url?url=https%3A%2F%2Ft.me%2Fiv%3Furl%3Dhttps%253A%252F%252Fcrispgm.com%252Fpage%252Fcontainerizing-my-vps.html%26rhash%3Da3e6c7b51eec6a">
            <i class="icon-telegram"></i>
          </a>
          <a href="https://www.buymeacoffee.com/crispgm">
            <i class="icon-coffee"></i>
          </a>
        </div>
        <div id="disqus_thread" class="article-comment"></div>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
      </div>
    </div>
    <footer class="wrapper" id="contact">
  <div class="content content-wrapper">
    <div class="contact">
      <div class="contact-links">
        <a href="mailto:crispgm@gmail.com"><i class="icon-envelope-o"></i></a>
        <a href="/feed.xml"><i class="icon-rss"></i></a>
        <a href="https://github.com/crispgm"><i class="icon-github"></i></a>
        <a href="https://stackoverflow.com/users/6858150/david-zhang/"><i class="icon-stack-overflow"></i></a>
        <a href="https://instagram.com/crispgm"><i class="icon-instagram"></i></a>
        <a href="https://twitter.com/crispgm"><i class="icon-twitter"></i></a>
      </div>
      <div class="contact-left">
        <a href="https://crispgm.com">David Zhang</a> &copy; 2019
      </div>
    </div>
  </div>
</footer>

    
<script src="/assets/scripts/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


    
<script>
var disqus_config = function () {
  this.page.identifier = '/page/containerizing-my-vps.html';
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://crispgm.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>


  </body>
  <script>
document.addEventListener('scroll', function(e) {
  var wrapper   = document.querySelector('.blog-wrapper');
  var article   = document.querySelector('.article');
  var docHeight = wrapper.offsetHeight;
  var maxHeight = docHeight - window.innerHeight - article.offsetTop;
  var scrollTop = window.scrollY || window.scollTop || document.getElementsByTagName("html")[0].scrollTop;
  var ratio = scrollTop / maxHeight;
  var progressBar = document.querySelector('.progress-bar');
  var winWidth  = window.innerWidth;
  if (ratio <= 1.0) {
    progressBar.style.width = winWidth * ratio + 'px';
  }
  else {
    progressBar.style.width = winWidth + 'px';
  }
});
</script>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50708664-1', 'auto');
  ga('send', 'pageview');
</script>
</html>
