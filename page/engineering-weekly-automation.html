<!DOCTYPE html>
<html>
  <head>
  <meta charset="UTF-8">
  <meta name="description" content="Home page and blog of David Zhang (@crispgm), a minimalist programmer, photographer, and lifehacker."/>
  <title>技术周刊自动化 | CrispDev</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:site_name" content="Crisp.Dev">
  <meta property="og:image" content="https://crisp.dev/image/social-share-img.jpg">
  <meta property="twitter:card" content="summary_large_image">
  <link rel="canonical" href="https://crispgm.com/page/engineering-weekly-automation.html">
  
  <link rel="alternate" href="https://crisp.dev/page/engineering-weekly-automation.html">
  
  <link rel="alternate" href="https://crispgm.com/feed.xml" type="application/rss+xml" title="RSS">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans|Fira+Mono&display=swap">
  <link rel="icon" type="image/x-icon" href="/image/logo.png">
  
  <link rel="stylesheet" href="/assets/css/font.css?v=1668527645">
  
  
  <link rel="stylesheet" href="/assets/css/nord.css">
  
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" crossorigin="anonymous">
  
  <link rel="stylesheet" href="/assets/css/style.css">
  <script src="https://use.typekit.net/syr2mmc.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>
</head>

  <body>
    <div class="progress-bar"></div>
    <div class="wrapper blog-wrapper content-wrapper">
      <div class="article">
        <div class="article-menu">
          <div class="article-home">
            <a href="/">CrispDev</a>
          </div>
          <div class="article-back">
            <a href="/blog.html"><< Back</a>
          </div>
        </div>
        <div class="article-head">
          <div class="article-title">
            技术周刊自动化
          </div>
          <div class="article-date">
            <time datetime="2016-12-06 00:00:00 +0000">December 06, 2016</time>
          </div>
        </div>
        <div class="article-main">
          <h2 id="背景">背景</h2>

<p>技术博客和技术周刊对于一个有技术追求的技术团队来说都是标配，意义在于团队的技术氛围。由于日常业务繁忙和技术深度等原因，大多数技术周刊都是以转载为主。技术周刊的“主编”也就是负责人，肯定需要从事文章收集、筛选、格式化、校验和编译，并不需要编辑什么内容。这部分工作量不大，但枯燥无意义。我也是其中的一员，因此我决定用“技术周刊自动化”来解决技术周刊的整套收集、筛选、校验和发布的流程。</p>

<p>这是我所在团队的技术博客 <a href="https://msbu-tech.github.io/">https://msbu-tech.github.io/</a>，基于 Jekyll 创建，分为博客、周刊、分享、项目等板块。其中，最活跃的就是<a href="https://msbu-tech.github.io/weekly/">技术周刊</a>。技术周刊每周都会发布，接收所有团队成员投稿，收集编译完毕后会发布到网站上，并且需要再在内部邮件组转一份。</p>

<h2 id="如何自动化">如何自动化？</h2>

<p>整体思路是基于 GitHub 构建一套自动化流程，通过 issues 进行收集，然后用脚本调用 GitHub API 处理导入和编译的各项步骤。</p>

<p>由于是 Jekyll 是 Ruby 编写的，因此选择 Ruby 比较合适。并且由于只是一些简单的任务式脚本，所以选择 <code class="language-plaintext highlighter-rouge">Rakefile</code> 作为载体来编写。</p>

<h3 id="整体流程">整体流程</h3>

<ol>
  <li>在 issues 中开启收集贴</li>
  <li>从 issues 中导入周刊（处理格式、生成 yaml 和 markdown）</li>
  <li>人工编译确认和自动化检测</li>
  <li>发布然后关闭 issue 并感谢投稿人</li>
  <li>完成 Wunderlist 中的任务</li>
</ol>

<h3 id="准备工作">准备工作</h3>

<h4 id="github-api">GitHub API</h4>

<p>选择 Ruby 还有个好处就是 GitHub 自身是用 Ruby 编写，因此 GitHub API 的 Ruby 库 <a href="https://github.com/octokit/octokit.rb">Octokit.rb</a> 非常简单好用。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">client</span> <span class="o">=</span> <span class="no">Octokit</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:access_token</span> <span class="o">=&gt;</span> <span class="n">access_token</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="access_token">access_token</h4>

<p><code class="language-plaintext highlighter-rouge">access_token</code> 不能对外暴露，因此需要在环境变量中设置或者通过指定环境变量来运行 <code class="language-plaintext highlighter-rouge">rake</code>。</p>

<h4 id="msbu-bot">msbu-bot</h4>

<p>作为一个自动化的工作，我引入了一个机器人账号 <a href="https://github.com/msbu-bot/">msbu-bot</a>，在调用 GitHub API 时使用。</p>

<h3 id="文章收集">文章收集</h3>

<p>建立一个专门 Repo 收集周刊内容 <a href="https://github.com/msbu-tech/weekly">msbu-tech/weekly</a>。里面没有代码，只有 <code class="language-plaintext highlighter-rouge">README</code> 来说明投稿的步骤流程，而 issues 则是收集贴。</p>

<p>开始收集一周的周刊时，先用创建一个收集贴。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake open[2016-12-06]
</code></pre></div></div>

<p>也就是调用 <code class="language-plaintext highlighter-rouge">Octokit.rb</code> 发 issue 接口：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">client</span><span class="p">.</span><span class="nf">create_issue</span><span class="p">(</span><span class="n">repo_name</span><span class="p">,</span> <span class="n">issue_name</span><span class="p">,</span> <span class="s2">"MSBU Weekly </span><span class="si">#{</span><span class="n">weekly_date</span><span class="si">}</span><span class="s2"> is now in collecting. Post your entry following the instruction of &lt;https://github.com/msbu-tech/weekly#投稿&gt;."</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://crispgm.com/image/msbu-bot-open-issue.jpg" alt="" /></p>

<h3 id="导入和编译">导入和编译</h3>

<p>周刊文章收集完毕后，我们开始导入：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake weekly[2016-12-06, true]
</code></pre></div></div>

<p>文章投稿的格式是：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/post
- 疯狂的JSONP
- http://www.cnblogs.com/twobin/p/3395086.html
- 何为跨域？何为JSONP？JSONP技术能实现什么？是否有必要使用JSONP技术？
- javascript, jsonp, 跨域
</code></pre></div></div>

<p>这里面的工作主要是是遍历 issue，识别 <code class="language-plaintext highlighter-rouge">/post</code> 投稿标识，然后获取标签、链接、介绍或评语、标签，而回贴人的 ID 就视为推荐人。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">issue_comment</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
  <span class="n">body</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="ss">:body</span><span class="p">]</span>
  <span class="n">title</span> <span class="o">=</span> <span class="s2">""</span>
  <span class="n">link</span> <span class="o">=</span> <span class="s2">""</span>
  <span class="n">comment</span> <span class="o">=</span> <span class="s2">""</span>
  <span class="n">tags</span> <span class="o">=</span> <span class="no">Array</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">referrer</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="ss">:user</span><span class="p">][</span><span class="ss">:login</span><span class="p">]</span>
  <span class="n">body</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">).</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
    <span class="k">case</span> <span class="n">i</span>
    <span class="k">when</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">.</span><span class="nf">eql?</span><span class="p">(</span><span class="s2">"/post"</span><span class="p">)</span>
        <span class="nb">puts</span> <span class="s2">"[INFO] Skip comment </span><span class="si">#{</span><span class="n">number</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">item</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">.</span><span class="nf">green</span>
        <span class="k">break</span>
      <span class="k">end</span>
    <span class="k">when</span> <span class="mi">1</span>
      <span class="n">title</span> <span class="o">=</span> <span class="no">Spacifier</span><span class="p">.</span><span class="nf">spacify</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"- "</span><span class="p">).</span><span class="nf">at</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">when</span> <span class="mi">2</span>
      <span class="n">link</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"- "</span><span class="p">).</span><span class="nf">at</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">when</span> <span class="mi">3</span>
      <span class="n">comment</span> <span class="o">=</span> <span class="no">Spacifier</span><span class="p">.</span><span class="nf">spacify</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"- "</span><span class="p">).</span><span class="nf">at</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">when</span> <span class="mi">4</span>
      <span class="n">tags</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"- "</span><span class="p">).</span><span class="nf">at</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">articles</span> <span class="o">&lt;&lt;</span> <span class="p">{</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">title</span><span class="p">,</span> <span class="ss">:link</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="p">,</span> <span class="ss">:comment</span> <span class="o">=&gt;</span> <span class="n">comment</span><span class="p">,</span> <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="n">tags</span><span class="p">,</span> <span class="ss">:referrer</span> <span class="o">=&gt;</span> <span class="n">referrer</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>其中，<code class="language-plaintext highlighter-rouge">Spacifier</code> 是我自己做的一个 <a href="https://github.com/crispgm/spacifier">Gem</a>，用于在中英文共存的字符串中，在中英文之间加一个空格。这样可以优化显示效果，之前为了一些完美主义都是手动转的。<code class="language-plaintext highlighter-rouge">Spacifier</code> 目前功能还不太完善，后续会慢慢改善。</p>

<p>导入文件后会提示导入文章数，并创建周刊网页和邮件所需的 Markdown 文件。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[INFO] Imported 8 article(s).
</code></pre></div></div>

<h3 id="测试">测试</h3>

<p>导入了文章后，需要进行一些基本的测试。投稿人和主编们时常会写错写重复一些字段，所以做了个自动化测试进行重复检测和字段缺失检测。这也接了 Travis 进行持续集成。</p>

<p>同时，推荐一个好用的 Gem —— <a href="https://github.com/fazibear/colorize">colorize</a>。<code class="language-plaintext highlighter-rouge">colorize</code> “打开”了 <code class="language-plaintext highlighter-rouge">String</code>，需要报错的时候，只需要在输出的字符串后面调用 <code class="language-plaintext highlighter-rouge">.red</code> 方法，就可以在控制台用红色显示，很醒目。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">puts</span> <span class="s2">"[ERROR] Import articles error!"</span><span class="p">.</span><span class="nf">red</span>
</code></pre></div></div>

<h3 id="发布">发布</h3>

<p>最后一步就是发布了。</p>

<p>文件都已经生成好，只需要 <code class="language-plaintext highlighter-rouge">git push</code> 到 GitHub，就能生效了。</p>

<p>我们还需要做的是告诉大家周刊发布的好消息，对投稿人表示感谢，然后关闭掉 issue。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake publish
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">comment</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOL</span><span class="sh">
  Congratulations!
  MSBU Weekly </span><span class="si">#{</span><span class="n">weekly_date</span><span class="si">}</span><span class="sh"> is published on &lt;https://msbu-tech.github.io/weekly/</span><span class="si">#{</span><span class="n">weekly_date</span><span class="si">}</span><span class="sh">-weekly.html&gt;!
  Thanks </span><span class="si">#{</span><span class="n">contributors_list</span><span class="p">.</span><span class="nf">join</span> <span class="s1">', '</span><span class="si">}</span><span class="sh"> for your great contribution!
</span><span class="no">  EOL</span>

<span class="n">client</span><span class="p">.</span><span class="nf">add_comment</span><span class="p">(</span><span class="n">repo_name</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
<span class="n">client</span><span class="p">.</span><span class="nf">close_issue</span><span class="p">(</span><span class="n">repo_name</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://crispgm.com/image/msbu-bot-say-thanks-and-close.jpg" alt="" /></p>

<h3 id="完成-wunderlist">完成 Wunderlist</h3>

<p>这里需要再引入一个非官方的 Wunderlist API：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s2">"wunderlist-api"</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">wl</span> <span class="o">=</span> <span class="no">Wunderlist</span><span class="o">::</span><span class="no">API</span><span class="p">.</span><span class="nf">new</span><span class="p">({</span>
  <span class="ss">access_token: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"WLIST_ACCESS_TOKEN"</span><span class="p">],</span>
  <span class="ss">client_id: </span><span class="no">ENV</span><span class="p">[</span><span class="s2">"WLIST_CLIENT_ID"</span><span class="p">]</span>
<span class="p">})</span>

<span class="n">tasks</span> <span class="o">=</span> <span class="n">wl</span><span class="p">.</span><span class="nf">tasks</span><span class="p">([</span><span class="s2">"工作清单"</span><span class="p">])</span>
<span class="n">tasks</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">t</span><span class="p">.</span><span class="nf">title</span><span class="p">.</span><span class="nf">eql?</span><span class="p">(</span><span class="s2">"MSBU Tech Weekly"</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">weekly_date</span><span class="p">.</span><span class="nf">eql?</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">due_date</span><span class="p">)</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">completed</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">show_info</span><span class="p">(</span><span class="s2">"Completing wunderlist task..."</span><span class="p">)</span>
    <span class="k">break</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="写在最后">写在最后</h2>

<p>文章所说的<a href="https://github.com/crispgm/weekly">源码在此</a>，如果本文帮助了你或者给了一些启发，帮忙来个 Star 吧。</p>

        </div>
        <div class="article-share">
          <a href="https://twitter.com/share?url=https%3A%2F%2Fcrispgm.com%2Fpage%2Fengineering-weekly-automation.html&text=%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E8%87%AA%E5%8A%A8%E5%8C%96">
            <i class="icon-twitter"></i>
          </a>
          
          <a href="tg://msg_url?url=https%3A%2F%2Ft.me%2Fiv%3Furl%3Dhttps%253A%252F%252Fcrispgm.com%252Fpage%252Fengineering-weekly-automation.html%26rhash%3Da3e6c7b51eec6a">
            <i class="icon-telegram"></i>
          </a>
          <a href="https://www.buymeacoffee.com/crispgm">
            <i class="icon-coffee"></i>
          </a>
        </div>
        <div id="disqus_thread" class="article-comment"></div>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
      </div>
    </div>
    <footer class="wrapper" id="contact">
  <div class="content">
    <div class="contact">
      <div class="contact-links">
        <a href="mailto:crispgm+web@gmail.com"><i class="icon-envelope-o"></i></a>
        <a href="/feed.xml"><i class="icon-rss"></i></a>
        <a href="https://github.com/crispgm"><i class="icon-github"></i></a>
        <a href="https://stackoverflow.com/users/6858150/david-zhang/"><i class="icon-stack-overflow"></i></a>
        <a href="https://instagram.com/crispgm"><i class="icon-instagram"></i></a>
        <a href="https://twitter.com/crispgm"><i class="icon-twitter"></i></a>
      </div>
      <div class="contact-copyright">
        <a href="https://crispgm.com">David Zhang</a> &copy; 2022
      </div>
    </div>
  </div>
</footer>

    
<script src="/assets/scripts/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


    
<script>
var disqus_config = function () {
  this.page.identifier = '/page/engineering-weekly-automation.html';
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://crispgm.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>


  </body>
  <script>
document.addEventListener('scroll', function(e) {
  var wrapper   = document.querySelector('.blog-wrapper');
  var article   = document.querySelector('.article');
  var docHeight = wrapper.offsetHeight;
  var maxHeight = docHeight - window.innerHeight - article.offsetTop;
  var scrollTop = window.scrollY || window.scollTop || document.getElementsByTagName("html")[0].scrollTop;
  var ratio = scrollTop / maxHeight;
  var progressBar = document.querySelector('.progress-bar');
  var winWidth  = window.innerWidth;
  if (ratio <= 1.0) {
    progressBar.style.width = winWidth * ratio + 'px';
  }
  else {
    progressBar.style.width = winWidth + 'px';
  }
});
</script>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50708664-1', 'auto');
  ga('send', 'pageview');
</script>
</html>
